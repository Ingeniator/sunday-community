<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community WebApp</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; background: #f9fafb; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin: 1em 0; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
    button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-enroll { background: #5ee1a9; font-weight: bold; }
    .btn-cancel { background: #ff6b6b; color: #fff; }
    #events, #me { margin-top: 24px; }
  </style>
</head>
<body>
  <h1 id="title">🏓 Community Page</h1>
  <p id="welcome" style="font-weight:600;"></p>

  <section>
    <h2>📜 Rules</h2>
    <ul>
      <li>Respect each other</li>
      <li>No spam/ads without admin approval</li>
      <li>Play fair</li>
    </ul>
  </section>
  
  <section id="events">
    <h2>📅 Upcoming Events</h2>
    <table>
      <thead><tr><th>Title</th><th>Date</th><th>Place</th><th>Action</th></tr></thead>
      <tbody id="eventsBody"></tbody>
    </table>
  </section>

  <section id="me">
    <h2>🙋 My Enrollments</h2>
    <ul id="myEnrollments"></ul>
  </section>

  <div id="notTelegram" style="display:none; margin-top:24px;">
      <p>Open this page inside Telegram to see your personalized view.</p>
      <!-- Deep link opens your bot and launches this page as a WebApp -->
      <a id="openInTg" class="btn" href="https://t.me/padelday_bot?startapp=hello">Open in Telegram</a>
  </div>
  
  <script>
    const tg = window.Telegram.WebApp;
    const welcome = document.getElementById("welcome");
    const notTg = document.getElementById("notTelegram");
    tg.expand(); tg.ready();
    const INIT = tg.initData; // signed, for secure writes
    const API  = "https://script.google.com/macros/s/AKfycby6rtizVvtmUh9pohkXMXUwrAeQOdaAxcjf47AprBPN6Dk2yBoTFFhXZJ4wL7ZhvM4G9A/exec";

    function personalize() {
      if (!tg) {
        // Not inside Telegram WebView → show fallback
        notTg.style.display = "block";
        return;
      }
      tg.expand();
      tg.ready();

      // Safe for UI personalization (not for security-sensitive logic)
      const user = tg.initDataUnsafe?.user;
      if (user) {
        const uname = user.username ? `@${user.username}` : (user.first_name || "friend");
        welcome.textContent = `Welcome, ${uname}!`;
      } else {
        welcome.textContent = "Welcome!";
      }

      // Example: handle Register click (placeholder)
      document.getElementById("registerBtn").addEventListener("click", () => {
        tg.showPopup({ title: "Coming soon!", message: "We’ll enable registration here later." });
      });

      // Optional: read start parameter you passed via ?startapp=...
      // const startParam = tg.initDataUnsafe?.start_param; // e.g., event id
      // console.log("Start param:", startParam);
    }

    
    async function listEvents() {
      const res = await fetch(`${API}?action=list_events`);
      const { ok, events, error } = await res.json();
      if (!ok) return alert(error);
      const tbody = document.getElementById("eventsBody");
      tbody.innerHTML = "";
      events.forEach(ev => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${ev.title}</td>
          <td>${ev.date}</td>
          <td>${ev.place}</td>
          <td><button class="btn-enroll">Enroll</button></td>`;
        tr.querySelector("button").onclick = () => enroll(ev.event_id);
        tbody.appendChild(tr);
      });
    }

    async function enroll(eventId) {
      const res = await fetch(API, {
        method: 'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'enroll', init_data: INIT, event_id: eventId })
      });
      const j = await res.json();
      tg.showPopup({ title: j.ok ? "Enrolled ✅" : "Error", message: j.ok ? "See you there!" : (j.error||"Try again") });
      if (j.ok) loadMe();
    }

    async function loadMe() {
      const res = await fetch(`${API}?action=me&init_data=${encodeURIComponent(INIT)}`);
      const j = await res.json();
      const list = document.getElementById("myEnrollments");
      list.innerHTML = "";
      if (j.ok && j.enrollments.length) {
        j.enrollments.forEach(r => {
          const li = document.createElement("li");
          li.textContent = `Enrolled in: ${r.event_id} at ${r.ts}`;
          list.appendChild(li);
        });
      } else {
        list.innerHTML = "<li>No enrollments yet.</li>";
      }
    }

    async function addEvent(ev) {
      const res = await fetch(API, {
        method:'POST', headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ action:'add_event', init_data: INIT, event: ev })
      });
      const j = await res.json();
      tg.showPopup({ title: j.ok ? "Event added" : "Error", message: j.ok ? "Published." : (j.error||"No access") });
    }

    personalize();
    listEvents();
    loadMe();
  </script>
</body>
</html>

</body>
</html>
