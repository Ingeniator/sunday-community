<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community Page</title>
  <link rel="stylesheet" href="style.css">
  <!-- Telegram WebApp SDK -->
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
</head>
<body>
  <main>
    <h1 id="title">üèì Community Page</h1>
    <p id="welcome" style="font-weight:600;"></p>

    <section>
      <h2>üìú Rules</h2>
      <ul>
        <li>Respect each other</li>
        <li>No spam/ads without admin approval</li>
        <li>Play fair</li>
      </ul>
    </section>

    <section>
      <h2>üìÖ Upcoming Event</h2>
      <p><strong>Weekend Tournament</strong><br>
      üóì 5 October ‚Ä¢ üìç Court A</p>
      <button id="registerBtn">Register</button>
    </section>

    <div id="notTelegram" style="display:none; margin-top:24px;">
      <p>Open this page inside Telegram to see your personalized view.</p>
      <!-- Deep link opens your bot and launches this page as a WebApp -->
      <a id="openInTg" class="btn" href="https://t.me/YourBot?startapp=hello">Open in Telegram</a>
    </div>
  </main>

  <script>
    const tg = window.Telegram?.WebApp;
    const welcome = document.getElementById("welcome");
    const notTg = document.getElementById("notTelegram");

    function personalize() {
      if (!tg) {
        // Not inside Telegram WebView ‚Üí show fallback
        notTg.style.display = "block";
        return;
      }
      tg.expand();
      tg.ready();

      // Safe for UI personalization (not for security-sensitive logic)
      const user = tg.initDataUnsafe?.user;
      if (user) {
        const uname = user.username ? `@${user.username}` : (user.first_name || "friend");
        welcome.textContent = `Welcome, ${uname}!`;
      } else {
        welcome.textContent = "Welcome!";
      }

      // Example: handle Register click (placeholder)
      document.getElementById("registerBtn").addEventListener("click", () => {
        tg.showPopup({ title: "Coming soon!", message: "We‚Äôll enable registration here later." });
      });

      // Optional: read start parameter you passed via ?startapp=...
      // const startParam = tg.initDataUnsafe?.start_param; // e.g., event id
      // console.log("Start param:", startParam);
    }

    personalize();
</script>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<script>
  const tg = window.Telegram.WebApp;
  tg.expand(); tg.ready();
  const INIT = tg.initData; // signed, for secure writes
  const API  = "https://script.google.com/macros/s/AKfycby6rtizVvtmUh9pohkXMXUwrAeQOdaAxcjf47AprBPN6Dk2yBoTFFhXZJ4wL7ZhvM4G9A/exec";

  async function listEvents(){
    const res = await fetch(`${API}?action=list_events`, {cache:'no-store'});
    const { ok, events, error } = await res.json();
    if (!ok) return alert(error);
    // TODO: render your table
    console.log(events);
  }

  async function enroll(eventId){
    const res = await fetch(API, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'enroll', init_data: INIT, event_id: eventId })
    });
    const j = await res.json();
    tg.showPopup({ title: j.ok ? "Enrolled ‚úÖ" : "Error", message: j.ok ? "See you there!" : (j.error||"Try again") });
  }

  async function loadMe(){
    const res = await fetch(`${API}?action=me&init_data=` + encodeURIComponent(INIT), {cache:'no-store'});
    const j = await res.json();
    console.log('me:', j);
    // TODO: show ‚ÄúWelcome, @username‚Äù and their enrollments
  }

  async function addEvent(ev) {
    const res = await fetch(API, {
      method:'POST', headers:{'Content-Type':'application/json'},
      body: JSON.stringify({ action:'add_event', init_data: INIT, event: ev })
    });
    const j = await res.json();
    tg.showPopup({ title: j.ok ? "Event added" : "Error", message: j.ok ? "Published." : (j.error||"No access") });
  }
  
  listEvents();
  loadMe();
</script>

</body>
</html>
