<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Community WebApp</title>
  <link rel="stylesheet" href="style.css">
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    body { font-family: system-ui, sans-serif; padding: 20px; background: #f9fafb; }
    h1 { text-align: center; }
    table { width: 100%; border-collapse: collapse; margin: 1em 0; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; }
    button { padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-enroll { background: #5ee1a9; font-weight: bold; }
    .btn-cancel { background: #ff6b6b; color: #fff; }
    #events, #me { margin-top: 24px; }
  </style>
</head>
<body>
  <h1 id="title">üèì Community Page</h1>
  <p id="welcome" style="font-weight:600;"></p>

  <section>
    <h2>üìú Rules</h2>
    <ul>
      <li>Respect each other</li>
      <li>No spam/ads without admin approval</li>
      <li>Play fair</li>
    </ul>
  </section>
  
  <section id="events">
    <h2>üìÖ Upcoming Events</h2>
    <table>
      <thead><tr><th>Title</th><th>Date</th><th>Place</th><th>Action</th></tr></thead>
      <tbody id="eventsBody"></tbody>
    </table>
  </section>

  <section id="me">
    <h2>üôã My Enrollments</h2>
    <ul id="myEnrollments"></ul>
  </section>

  <section id="admin" style="display:none; margin-top:24px;">
  <h2>üõ† Admin: Add Event</h2>
  <form id="addEventForm">
    <div style="display:grid; gap:8px; max-width:520px;">
      <label>Event ID
        <input name="event_id" placeholder="evt_2025_10_05" required>
      </label>
      <label>Title
        <input name="title" placeholder="Weekend Tournament" required>
      </label>
      <label>Date
        <input name="date" type="date" required>
      </label>
      <label>Place
        <input name="place" placeholder="Court A">
      </label>
      <label>Status
        <select name="status">
          <option>Open</option>
          <option>Info</option>
          <option>RSVP</option>
          <option>Archived</option>
        </select>
      </label>
      <label>Total slots
        <input name="total_slots" type="number" min="0" placeholder="48">
      </label>
      <label>Action URL
        <input name="action_url" placeholder="https://t.me/padelday_bot?startapp=evt_2025_10_05">
      </label>
      <button type="submit" class="btn-enroll">Add Event</button>
    </div>
  </form>
</section>


  <div id="notTelegram" style="display:none; margin-top:24px;">
      <p>Open this page inside Telegram to see your personalized view.</p>
      <!-- Deep link opens your bot and launches this page as a WebApp -->
      <a id="openInTg" class="btn" href="https://t.me/padelday_bot?startapp=hello">Open in Telegram</a>
  </div>
    
<button id="toggleDebug" style="position:fixed;right:12px;bottom:12px;padding:6px 10px;border-radius:8px;border:1px solid #ddd;background:#fff;cursor:pointer;">üêû Debug</button>

<div id="debug" style="font:12px monospace; white-space:pre-wrap; background:#eee; padding:8px; display:none;"></div>
<script>
  // Safe detection: only set tg if the SDK AND WebApp exist
  const tg = (window.Telegram && window.Telegram.WebApp) ? window.Telegram.WebApp : null;

  const welcome = document.getElementById("welcome");
  const notTg   = document.getElementById("notTelegram");

  // Your Apps Script endpoint:
  const API  = "https://script.google.com/macros/s/AKfycby6rtizVvtmUh9pohkXMXUwrAeQOdaAxcjf47AprBPN6Dk2yBoTFFhXZJ4wL7ZhvM4G9A/exec";

  // "Inside Telegram" detection: initData is non-empty only in real WebApp
  const inTelegram = !!(tg && typeof tg.initData === "string" && tg.initData.length > 0);
  const INIT = inTelegram ? tg.initData : ""; // signed payload only when available

  // Toggle debug panel
  document.getElementById("toggleDebug").addEventListener("click", () => {
    const d = document.getElementById("debug");
    d.style.display = d.style.display === "none" ? "block" : "none";
  });
  
  // Helper logger
  function dbg(...a){
    const d = document.getElementById("debug");
    d.style.display = "block";
    d.textContent += a.map(x => typeof x === "string" ? x : JSON.stringify(x, null, 2)).join(" ") + "\n";
  }

  dbg("inTelegram:", inTelegram ? "yes" : "no");
  dbg("INIT length:", (tg && tg.initData) ? tg.initData.length : 0);
  dbg("unsafe user:", tg && tg.initDataUnsafe && tg.initDataUnsafe.user ? JSON.stringify(tg.initDataUnsafe.user) : "none");
  dbg("start_param:", tg && tg.initDataUnsafe ? tg.initDataUnsafe.start_param : "none");
  
  // Show user IDs (unsafe vs. server-verified)
  async function showUserIds(){
    const inTelegram = !!(tg && typeof tg.initData === "string" && tg.initData.length > 0);
  
    if (!inTelegram) {
      dbg("Not in Telegram WebApp. No Telegram user id available.");
      dbg("Tip: open via https://t.me/<YourBot>?startapp=hello");
      return;
    }
  
    // 1) Client (unsafe) ID
    const u = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    if (u) {
      dbg("Client (unsafe) user.id:", u.id, "username:", u.username || "");
    } else {
      dbg("Client (unsafe) user is missing.");
    }
  
    // 2) Server-verified ID via /me (or /whoami)
    try {
      const res = await fetch(`${API}?action=me&init_data=${encodeURIComponent(INIT)}`, { cache: "no-store" });
      const j = await res.json();
      if (j.ok && j.user) {
        dbg("Server-verified user.id:", j.user.id, "username:", j.user.username || "");
        if (j.is_admin !== undefined) dbg("is_admin:", j.is_admin);
      } else {
        dbg("Server verification failed:", j);
      }
    } catch (e) {
      dbg("Server verification error:", String(e));
    }

    // 3) Server-verified DEBUG SIGNATURE
    try {
      const res = await fetch(`${API}?action=debug_sig&init_data=${encodeURIComponent(INIT)}`, { cache: "no-store" });
      const j = await res.json();
      dbg("debug_sig:", j); // <‚Äî always print
    } catch (e) {
      dbg("Server debug_sig error:", String(e));
    }

    // 4) test
    try {
      const res = await fetch(`${API}?action=getme}`, { cache: "no-store" });
      const j = await res.json();
      dbg("getMe:", j); // <‚Äî always print
    } catch (e) {
      dbg("Server getMe error:", String(e));
    }


  }
  
  // Call it on load
  showUserIds();
  
  function personalize() {
    if (!inTelegram) {
      // Not inside Telegram WebView ‚Üí show fallback block
      notTg.style.display = "block";
      welcome.textContent = "Welcome!";
      return;
    }
    // We're inside Telegram WebApp ‚Äî safe to call these now
    tg.expand();
    tg.ready();

    const user = (tg.initDataUnsafe && tg.initDataUnsafe.user) ? tg.initDataUnsafe.user : null;
    if (user) {
      const uname = user.username ? `@${user.username}` : (user.first_name || "friend");
      welcome.textContent = `Welcome, ${uname}!`;
    } else {
      welcome.textContent = "Welcome!";
    }
  }

  async function listEvents() {
    const res = await fetch(`${API}?action=list_events`, { cache:'no-store' });
    const { ok, events, error } = await res.json();
    if (!ok) { alert(error || "Failed to load events"); return; }

    const tbody = document.getElementById("eventsBody");
    tbody.innerHTML = "";
    if (!Array.isArray(events) || events.length === 0) {
      tbody.innerHTML = `<tr><td colspan="4">No events</td></tr>`;
      return;
    }
    events.forEach(ev => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${ev.title ?? ""}</td>
        <td>${ev.date ?? ""}</td>
        <td>${ev.place ?? ""}</td>
        <td><button class="btn-enroll">Enroll</button></td>`;
      tr.querySelector("button").onclick = () => enroll(ev.event_id);
      tbody.appendChild(tr);
    });
  }

  // No custom headers ‚Üí avoids Safari/iOS preflight issues
  async function enroll(eventId) {
    const res = await fetch(API, {
      method: 'POST',
      body: JSON.stringify({ action:'enroll', init_data: INIT, event_id: eventId })
    });
    const j = await res.json();
    if (inTelegram && tg.showPopup) {
      tg.showPopup({ title: j.ok ? "Enrolled ‚úÖ" : "Error", message: j.ok ? "See you there!" : (j.error||"Try again") });
    } else {
      alert(j.ok ? "Enrolled ‚úÖ" : (j.error||"Try again"));
    }
    if (j.ok) loadMe();
  }

  async function unenroll(eventId) {
    const res = await fetch(API, {
      method: 'POST',
      body: JSON.stringify({ action:'unenroll', init_data: INIT, event_id: eventId })
    });
    const j = await res.json();
    if (inTelegram && tg.showPopup) {
      tg.showPopup({ title: j.ok ? "Unenrolled ‚úÖ" : "Error", message: j.ok ? "See you next time!" : (j.error||"Try again") });
    } else {
      alert(j.ok ? "Unenrolled ‚úÖ" : (j.error||"Try again"));
    }
    if (j.ok) loadMe();
  }

  async function loadMe() {
    // If not in Telegram, skip calling /me (no init_data to verify)
    if (!inTelegram) return;

    const res = await fetch(`${API}?action=me&init_data=${encodeURIComponent(INIT)}`, { cache:'no-store' });
    const j = await res.json();

    // My enrollments
    const list = document.getElementById("myEnrollments");
    list.innerHTML = "";
    if (j.ok && Array.isArray(j.enrollments) && j.enrollments.length) {
      j.enrollments.forEach(r => {
        const li = document.createElement("li");
        li.textContent = `Enrolled in: ${r.event_id} at ${r.ts}`;
        list.appendChild(li);
      });
    } else {
      list.innerHTML = "<li>No enrollments yet.</li>";
    }

    if (j.ok) {
      document.getElementById("welcome").textContent += ` (ID: ${j.user.id})`;
    }
    
    // Admin panel toggle AND attach handler
    if (j.ok && j.is_admin) {
      const admin = document.getElementById("admin");
      admin.style.display = "block";
      addEventHandle(); // <-- attach submit handler once panel is shown
    }
  }

  // Attach submit handler for Admin form
  function addEventHandle() {
    const form = document.getElementById("addEventForm");
    if (!form) return;
    // Avoid double-binding
    if (form.dataset.bound === "1") return;
    form.dataset.bound = "1";

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      const fd = new FormData(form);
      const ev = Object.fromEntries(fd.entries());
      // Normalize & validate minimal fields
      ev.total_slots = ev.total_slots ? Number(ev.total_slots) : '';
      ev.status = ev.status || 'Open';

      const res = await fetch(API, {
        method:'POST',
        body: JSON.stringify({ action:'add_event', init_data: INIT, event: ev })
      });
      const j = await res.json();
      if (inTelegram && tg.showPopup) {
        tg.showPopup({ title: j.ok ? "Event added" : "Error", message: j.ok ? "Published." : (j.error||"No access") });
      } else {
        alert(j.ok ? "Event added" : (j.error||"No access"));
      }
      if (j.ok) {
        form.reset();
        await listEvents();
      }
    });
  }

  // Boot
  personalize();
  listEvents();
  loadMe();
</script>

</body>
</html>
